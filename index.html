<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>成本計算器（自動匯率與稅）</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 600px; margin: auto; }
    label, input, select, button { display: block; margin: 8px 0; width: 100%; }
    button { padding: 10px; }
    .admin-link { margin-top: 30px; text-align: center; }
  </style>
</head>
<body>
  <h1>商品成本計算</h1>
  <form id="cost-form">
    <label>商品名稱<input id="productName" required /></label>
    <label>分類
      <select id="category" required>
        <option value="用品">用品</option>
        <option value="食品">食品</option>
        <option value="經銷商">經銷商</option>
        <option value="籠子">籠子</option>
      </select>
    </label>
    <label>商品成本（人民幣）<input id="unitCost" type="number" step="0.01" required /></label>
    <label>境內運費（人民幣）<input id="domesticShipping" type="number" step="0.01" value="0" /></label>
    <label>跨境運費（台幣）<input id="crossShipping" type="number" step="0.01" value="0" /></label>
    <label>售價（台幣）<input id="sellingPrice" type="number" step="0.01" required /></label>
    <label>蝦皮抽成（%）<input id="shopeeFee" type="number" step="0.1" value="13.5" /></label>

    <p id="tariff-display"></p>
    <p id="total-display"></p>
    <p id="gross-display"></p>
    <p id="gross-percent-display"></p>

    <button type="submit">計算並儲存</button>
    <p id="rate-display"></p>
  </form>

  <div class="admin-link">
    <a href="admin.html"><button>前往後台管理</button></a>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      "https://sqkqqmpxxukrbjgkjcdk.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxa3FxbXB4eHVrcmJqZ2tqY2RrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3NzI2NTgsImV4cCI6MjA2OTM0ODY1OH0.iHEj0HyfCOcnf6F0J3DKYE9JWQnqZNReoZliLoJhvRk"
    );

    let exchangeRate = 4.5; // fallback 預設

    async function fetchExchangeRate() {
      try {
        const res = await fetch('https://www.taifex.com.tw/cht/3/dlFutDataDown?down_type=1&commodity_id=USD');
        // 可改為中央銀行或其他 API，這裡只是範例
      } catch (e) {
        console.warn('無法取得匯率，使用預設 4.5');
      }
    }

    async function saveToSupabase(e) {
      e.preventDefault();

      const name = document.getElementById('productName').value;
      const category = document.getElementById('category').value;
      const unitCost = parseFloat(document.getElementById('unitCost').value);
      const domShip = parseFloat(document.getElementById('domesticShipping').value);
      const crossShip = parseFloat(document.getElementById('crossShipping').value);
      const price = parseFloat(document.getElementById('sellingPrice').value);
      const feePct = parseFloat(document.getElementById('shopeeFee').value);

      const costNTD = unitCost * exchangeRate;
      const domShipNTD = domShip * exchangeRate;
      const tariff = 0.1 * costNTD;

      const totalCost = costNTD + domShipNTD + crossShip + tariff;
      const shopeeFeeValue = price * feePct / 100;
      const gross = price - totalCost - shopeeFeeValue;
      const grossPct = price ? (gross / price * 100) : 0;

      document.getElementById('tariff-display').innerText = `預估關稅（10% 商品成本）：約 ${tariff.toFixed(2)} 元台幣`;
      document.getElementById('total-display').innerText = `總成本（含運費與關稅）：約 ${totalCost.toFixed(2)} 元台幣`;
      document.getElementById('gross-display').innerText = `毛利：${gross.toFixed(2)} 元台幣`;
      document.getElementById('gross-percent-display').innerText = `毛利率：${grossPct.toFixed(2)}%`;

      const record = {
        product_name: name,
        category: category,
        currency: 'CNY',
        unit_cost: unitCost,
        exchange_rate: exchangeRate,
        domestic_shipping: domShip,
        cross_shipping: crossShip,
        tariff: parseFloat(tariff.toFixed(2)),
        selling_price: price,
        shopee_fee: feePct,
        total_cost: parseFloat(totalCost.toFixed(2)),
        shopee_fee_value: parseFloat(shopeeFeeValue.toFixed(2)),
        gross_margin: parseFloat(gross.toFixed(2)),
        gross_margin_percent: parseFloat(grossPct.toFixed(2))
      };

      const { error } = await supabase.from('products').insert([record]);
      if (error) {
        alert('儲存失敗');
        console.error(error);
      } else {
        alert('儲存成功');
        document.getElementById('cost-form').reset();
        document.getElementById('tariff-display').innerText = "";
        document.getElementById('total-display').innerText = "";
        document.getElementById('gross-display').innerText = "";
        document.getElementById('gross-percent-display').innerText = "";
      }
    }

    document.getElementById('cost-form').addEventListener('submit', saveToSupabase);

    // 自動顯示匯率（暫時顯示為固定）
    document.getElementById('rate-display').innerText = `目前使用匯率為：${exchangeRate}`;
  </script>
</body>
</html>
