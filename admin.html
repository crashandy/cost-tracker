<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>商品管理介面</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 960px; margin: auto; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    input[type="text"], input[type="number"] { width: 100%; }
    .filters { margin-top: 20px; display: flex; gap: 10px; align-items: center; }
  </style>
</head>
<body>
  <h1>商品管理介面</h1>
  <div id="login-box">
    <p>請輸入密碼：</p>
    <input type="password" id="password" />
    <button id="login-button">登入</button>
  </div>

  <div id="admin-panel" style="display:none">
    <div class="filters">
      <input type="text" id="searchKeyword" placeholder="搜尋商品名稱..." />
      <select id="categoryFilter">
        <option value="">全部分類</option>
        <option value="用品">用品</option>
        <option value="食品">食品</option>
        <option value="經銷商">經銷商</option>
        <option value="籠子">籠子</option>
      </select>
      <button onclick="exportCSV()">匯出 CSV</button>
    </div>
    <table id="product-table">
      <thead>
        <tr>
          <th>商品名稱</th>
          <th>分類</th>
          <th>成本 (人民幣)</th>
          <th>匯率</th>
          <th>境內運費 (人民幣)</th>
          <th>跨境運費 (台幣)</th>
          <th>關稅 (台幣)</th>
          <th>售價 (台幣)</th>
          <th>蝦皮抽成 (%)</th>
          <th>總成本 (台幣)</th>
          <th>抽成金額 (台幣)</th>
          <th>毛利 (台幣)</th>
          <th>毛利率 (%)</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const PASSWORD = "93586386";
    const supabase = window.supabase.createClient(
      "https://sqkqqmpxxukrbjgkjcdk.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxa3FxbXB4eHVrcmJqZ2tqY2RrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3NzI2NTgsImV4cCI6MjA2OTM0ODY1OH0.iHEj0HyfCOcnf6F0J3DKYE9JWQnqZNReoZliLoJhvRk"
    );

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("login-button").addEventListener("click", () => {
        const input = document.getElementById("password").value;
        if (input === PASSWORD) {
          document.getElementById("login-box").style.display = "none";
          document.getElementById("admin-panel").style.display = "block";
          fetchData();
        } else {
          alert("密碼錯誤");
        }
      });

      document.getElementById("searchKeyword").addEventListener("input", fetchData);
      document.getElementById("categoryFilter").addEventListener("change", fetchData);
    });

    async function fetchData() {
      const keyword = document.getElementById('searchKeyword').value.toLowerCase();
      const category = document.getElementById('categoryFilter').value;

      let { data, error } = await supabase.from("products").select("*").order("created_at", { ascending: false });
      if (error) return alert("讀取失敗");

      if (keyword) {
        data = data.filter(item => item.product_name.toLowerCase().includes(keyword));
      }
      if (category) {
        data = data.filter(item => item.category === category);
      }

      const tbody = document.querySelector("#product-table tbody");
      tbody.innerHTML = "";
      data.forEach((row) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="text" value="${row.product_name}" onchange="updateField('${row.id}', 'product_name', this.value)"/></td>
          <td>${row.category || ''}</td>
          <td>${row.unit_cost ?? ''}</td>
          <td>${row.exchange_rate ?? ''}</td>
          <td>${row.domestic_shipping ?? ''}</td>
          <td>${row.cross_shipping ?? ''}</td>
          <td>${row.tariff ?? ''}</td>
          <td><input type="number" value="${row.selling_price ?? ''}" onchange="updateField('${row.id}', 'selling_price', this.value)"/></td>
          <td>${row.shopee_fee ?? ''}</td>
          <td>${row.total_cost ?? ''}</td>
          <td>${row.shopee_fee_value ?? ''}</td>
          <td>${row.gross_margin ?? ''}</td>
          <td>${row.gross_margin_percent ?? ''}</td>
          <td><button onclick="deleteRow('${row.id}')">刪除</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function updateField(id, field, value) {
      const { error } = await supabase.from("products").update({ [field]: value }).eq("id", id);
      if (error) alert("更新失敗");
      else fetchData();
    }

    async function deleteRow(id) {
      if (!confirm("確認刪除？")) return;
      const { error } = await supabase.from("products").delete().eq("id", id);
      if (error) alert("刪除失敗");
      else fetchData();
    }

    function exportCSV() {
      const rows = document.querySelectorAll("#product-table tr");
      const headers = [
        "商品名稱", "分類", "成本 (人民幣)", "匯率", "境內運費 (人民幣)", "跨境運費 (台幣)", "關稅 (台幣)",
        "售價 (台幣)", "蝦皮抽成 (%)", "總成本 (台幣)", "抽成金額 (台幣)", "毛利 (台幣)", "毛利率 (%)"
      ];
      let csv = headers.join(',') + "\n";
      rows.forEach((tr, i) => {
        if (i === 0) return;
        const cols = tr.querySelectorAll("td");
        if (cols.length) {
          const values = Array.from(cols).slice(0, 13).map(td => td.querySelector("input") ? td.querySelector("input").value : td.textContent.trim());
          csv += values.join(',') + "\n";
        }
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "products.csv";
      link.click();
    }
  </script>
</body>
</html>
