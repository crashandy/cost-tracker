<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>成本計算器（自動匯率與稅）</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 600px; margin: auto; }
    label, input, select, button { display: block; margin: 8px 0; width: 100%; }
    button { padding: 10px; }
    .admin-link { margin-top: 30px; text-align: center; }
    #preview { width: 100px; height: 100px; object-fit: cover; display: none; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>商品成本計算</h1>
  <form id="cost-form">
    <label>商品名稱<input id="productName" required /></label>
    <label>分類
      <select id="category" required>
        <option value="用品">用品</option>
        <option value="食品">食品</option>
        <option value="經銷商">經銷商</option>
        <option value="籠子">籠子</option>
      </select>
    </label>
    <label>商品成本（人民幣）<input id="unitCost" type="number" step="0.01" required /></label>
    <label>境內運費（人民幣）<input id="domesticShipping" type="number" step="0.01" value="0" /></label>
    <label>跨境運費（台幣）<input id="crossShipping" type="number" step="0.01" value="0" /></label>
    <label>售價（台幣）<input id="sellingPrice" type="number" step="0.01" required /></label>
    <label>蝦皮抽成（%）<input id="shopeeFee" type="number" step="0.1" value="13.5" /></label>

    <label>商品圖片<input type="file" accept="image/*" id="imageInput" /></label>
    <img id="preview" />

    <label>預估關稅（台幣）<input id="tariffValue" type="number" readonly /></label>
    <label>總成本（台幣）<input id="totalCostValue" type="number" readonly /></label>
    <label>毛利（台幣）<input id="grossValue" type="number" readonly /></label>
    <label>毛利率（%）<input id="grossPercentValue" type="number" readonly /></label>

    <button type="submit">計算並儲存</button>
    <p id="rate-display"></p>
  </form>

  <div class="admin-link">
    <a href="admin.html"><button>前往後台管理</button></a>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      "https://sqkqqmpxxukrbjgkjcdk.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxa3FxbXB4eHVrcmJqZ2tqY2RrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3NzI2NTgsImV4cCI6MjA2OTM0ODY1OH0.iHEj0HyfCOcnf6F0J3DKYE9JWQnqZNReoZliLoJhvRk"
    );

    let exchangeRate = 4.5;

    document.getElementById('imageInput').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      const productName = document.getElementById('productName').value.trim();
      if (!file || !productName) return alert('請先輸入商品名稱再選擇圖片');

      const compressed = await imageCompression(file, { maxWidthOrHeight: 600, maxSizeMB: 0.2 });
      await supabase.storage.from("product-images").remove([`${productName}.jpg`]);
      await supabase.storage.from("product-images").upload(`${productName}.jpg`, compressed, { upsert: true });

      const preview = document.getElementById('preview');
      preview.src = `https://sqkqqmpxxukrbjgkjcdk.supabase.co/storage/v1/object/public/product-images/${productName}.jpg?ts=${Date.now()}`;
      preview.style.display = 'block';
    });

    async function saveToSupabase(e) {
      e.preventDefault();

      const name = document.getElementById('productName').value.trim();
      const category = document.getElementById('category').value;
      const unitCost = parseFloat(document.getElementById('unitCost').value);
      const domShip = parseFloat(document.getElementById('domesticShipping').value);
      const crossShip = parseFloat(document.getElementById('crossShipping').value);
      const price = parseFloat(document.getElementById('sellingPrice').value);
      const feePct = parseFloat(document.getElementById('shopeeFee').value);

      const costNTD = unitCost * exchangeRate;
      const domShipNTD = domShip * exchangeRate;
      const tariff = 0.1 * costNTD;
      const totalCost = costNTD + domShipNTD + crossShip + tariff;
      const shopeeFeeValue = price * feePct / 100;
      const gross = price - totalCost - shopeeFeeValue;
      const grossPct = price ? (gross / price * 100) : 0;

      document.getElementById('tariffValue').value = tariff.toFixed(2);
      document.getElementById('totalCostValue').value = totalCost.toFixed(2);
      document.getElementById('grossValue').value = gross.toFixed(2);
      document.getElementById('grossPercentValue').value = grossPct.toFixed(2);

      const record = {
        product_name: name,
        category: category,
        currency: 'CNY',
        unit_cost: unitCost,
        exchange_rate: exchangeRate,
        domestic_shipping: domShip,
        cross_shipping: crossShip,
        tariff: parseFloat(tariff.toFixed(2)),
        selling_price: price,
        shopee_fee: feePct,
        total_cost: parseFloat(totalCost.toFixed(2)),
        shopee_fee_value: parseFloat(shopeeFeeValue.toFixed(2)),
        gross_margin: parseFloat(gross.toFixed(2)),
        gross_margin_percent: parseFloat(grossPct.toFixed(2))
      };

      const { error } = await supabase.from('products').insert([record]);
      if (error) {
        alert('儲存失敗');
        console.error(error);
      } else {
        alert('儲存成功');
        document.getElementById('cost-form').reset();
        document.getElementById('preview').style.display = 'none';
      }
    }

    document.getElementById('cost-form').addEventListener('submit', saveToSupabase);
    document.getElementById('rate-display').innerText = `目前使用匯率為：${exchangeRate}`;
  </script>
</body>
</html>
